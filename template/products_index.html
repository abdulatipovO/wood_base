{% extends 'wrapper.html' %}

{% block content %}


    <div id="main">
            <header class="mb-3">
                <a href="#" class="burger-btn d-block d-xl-none">
                    <i class="bi bi-justify fs-3"></i>
                </a>
            </header>
            
<!-- <div class="page-heading">
    <h3>Profile Statistics</h3>
</div>  -->

<form class="form-group row" method="get">
    <div class="col-5">
        <input type="text" name="search" placeholder="Qidiruv..." class="form-control col-md-5" style="border-radius: 26px;" value="{{search_value|default:''}}">
    </div>
    <div class="col-3">
        <input type="date" name="start" class="form-control col-md-3" style="border-radius: 26px;" value="{{start_value}}">
        <label for="">..dan</label>
    </div>
    <div class="col-3">
        <input type="date" name="end" class="form-control col-md-3" style="border-radius: 26px;" value="{{end_value}}">
        <label for="">..gacha</label>
    </div>
    <div class="col-1">
        <button type="submit" class="btn btn-light-primary" style="border-radius: 26px;">✔️</button>
    </div>
</form>
                             
<div class="page-content"> 
    <section class="row" id="containers_list">


        {% if products_with_sales|length > 0 %}

        <div style="overflow-x:auto;">
        <table class="table table-striped mt-2" id="table1" style="white-space:nowrap;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Sanasi</th>
                    <th>Nomi</th>
                    <th>Konteyneri</th>
                    <th>Qoldiq kub</th>
                    <th>Qoldiq soni</th>
                    <th>Sotilgan dona</th>
                    <th>Sotilgan kub</th>
                    <th>Sotilgan UZS</th>
                    <th>Sotilgan USD</th>
                </tr>
                <tr id="totals-row" style="font-weight:bold;">
                    <td colspan="6">Jami:</td>
                    <td id="total-sold-qty">0</td>
                    <td id="total-sold-cube">0</td>
                    <td id="total-sold-uzs">0</td>
                    <td id="total-sold-usd">0</td>
                </tr>
            </thead>
            <tbody>
                {% for item in products_with_sales %}
                <tr>
                    <td>{{ item.product.id }}</td>
                    <td><a href="/container-products-detail/{{ item.product.product_container.id }}">{{ item.product.product_container.come_date|date:'d/m/Y' }}</a></td>
                    <td><a href="/container-products-detail/{{ item.product.product_container.id }}">{{ item.product.product_size.product_size_name }}</a></td>
                    <td><a href="/container-products-detail/{{ item.product.product_container.id }}">{{ item.product.product_container.name }}</a></td>
                    <td>{{ item.product.rest_cube|floatformat:4 }}</td>
                    <td>{{ item.product.rest_qty }}</td>
                    <td class="sold-qty">{{ item.sold_qty|floatformat:2 }}</td>
                    <td class="sold-cube">{{ item.sold_cube|floatformat:4 }}</td>
                    <td class="sold-uzs">{{ item.sold_uzs|floatformat:2 }}</td>
                    <td class="sold-usd">{{ item.sold_usd|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
        <script>
        // intcomma function (simple version for JS)
        function intcomma(x) {
            if (typeof x === 'number') x = x.toString();
            let parts = x.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join('.');
        }

        function sumTableColumn(cls, isFloat) {
            let sum = 0;
            document.querySelectorAll('.' + cls).forEach(function(td) {
                let val = td.textContent.replace(/,/g, '');
                if (isFloat) {
                    val = parseFloat(val) || 0;
                } else {
                    val = parseInt(val) || 0;
                }
                sum += val;
            });
            return sum;
        }

        function updateTotals() {
            let qty = sumTableColumn('sold-qty', true);
            let cube = sumTableColumn('sold-cube', true);
            let uzs = sumTableColumn('sold-uzs', true);
            let usd = sumTableColumn('sold-usd', true);
            document.getElementById('total-sold-qty').textContent = intcomma(qty.toFixed(2));
            document.getElementById('total-sold-cube').textContent = intcomma(cube.toFixed(4));
            document.getElementById('total-sold-uzs').textContent = intcomma(uzs.toFixed(2));
            document.getElementById('total-sold-usd').textContent = intcomma(usd.toFixed(2));
        }

        function formatTableNumbers() {
            // Format sold columns
            document.querySelectorAll('.sold-qty').forEach(function(td) {
                td.textContent = intcomma(td.textContent.replace(/,/g, ''));
            });
            document.querySelectorAll('.sold-cube').forEach(function(td) {
                td.textContent = intcomma(td.textContent.replace(/,/g, ''));
            });
            document.querySelectorAll('.sold-uzs').forEach(function(td) {
                td.textContent = intcomma(td.textContent.replace(/,/g, ''));
            });
            document.querySelectorAll('.sold-usd').forEach(function(td) {
                td.textContent = intcomma(td.textContent.replace(/,/g, ''));
            });
            // Format rest columns
            document.querySelectorAll('td:nth-child(5)').forEach(function(td) { // rest_cube
                if (!td.classList.contains('sold-cube')) td.textContent = intcomma(td.textContent.replace(/,/g, ''));
            });
            document.querySelectorAll('td:nth-child(6)').forEach(function(td) { // rest_qty
                if (!td.classList.contains('sold-qty')) td.textContent = intcomma(td.textContent.replace(/,/g, ''));
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            formatTableNumbers();
            updateTotals();
        });
        </script>
        </div>

        {% else %}
        <div class="col-md-12">
            <h5 class="text-center mt-5">Mahsulotlar mavjud emas !</h5>
        </div>
        {% endif %}   

    </section>
</div>

{% endblock content %}